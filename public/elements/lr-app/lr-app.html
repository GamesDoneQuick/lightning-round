<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../lr-login-cover/lr-login-cover.html">
<link rel="import" href="../lr-moderation-queue/lr-moderation-queue.html">
<link rel="import" href="../lr-prompt/lr-prompt.html">
<link rel="import" href="../lr-user-details/lr-user-details.html">

<dom-module id="lr-app">
	<template>
		<style>
			:host {
				display: block;
				width: 100%;
				max-width: 756px;
				padding: 0 6px;
			}
		</style>

		<!-- IMPORTANT: The firebase-app element needs to appear before other firebase-* elements -->
		<firebase-app
			id="firebase"
			auth-domain="[[firebaseConfig.authDomain]]"
			database-url="[[firebaseConfig.databaseUrl]]"
			api-key="[[firebaseConfig.apiKey]]">
		</firebase-app>

		<firebase-auth
			id="auth"
			user="{{user}}"
			provider="twitter">
		</firebase-auth>

		<firebase-document
			id="adminsQuery"
			path="/admins/[[user.uid]]"
			data="{{adminData}}">
		</firebase-document>

		<template is="dom-if" if="[[user]]">
			<lr-user-details user="[[user]]" on-logout="logout"></lr-user-details>
		</template>

		<template is="dom-if" if="[[userIsLoggedInAndNotAdmin(user, adminData)]]">
			<div>You have not been granted admin privileges.</div>
			<div>Please contact an administrator if you need to be granted admin privileges.</div>
		</template>

		<template is="dom-if" if="[[!user]]">
			<lr-login-cover on-login="login"></lr-login-cover>
		</template>

		<template is="dom-if" if="[[userIsAdmin(user, adminData)]]">
			<lr-prompt active-tweet-id="{{activeTweetId}}"></lr-prompt>
			<lr-moderation-queue active-tweet-id="[[activeTweetId]]" hidden="[[!activeTweetId]]"></lr-moderation-queue>
		</template>
	</template>

	<script>
		const PROD_CONFIG = {
			authDomain: 'lightning-round.firebaseapp.com',
			databaseUrl: 'https://lightning-round.firebaseio.com',
			apiKey: 'AIzaSyCQGPyU0FnB2W6nz-kQoz9TxjI0_i7bb8I'
		};

		const DEV_CONFIG = {
			authDomain: 'lightning-round-dev.firebaseapp.com',
			databaseUrl: 'https://lightning-round-dev.firebaseio.com',
			apiKey: 'AIzaSyDsaNRtDlHZ5LXHl14FOKBO53dfoxA5UFc'
		};

		Polymer({
		    is: 'lr-app',

			properties: {
		        user: {
		            type: Object,
		            value: null
				},
				adminData: {
		            type: Object,
					value: null
				},
				firebaseConfig: {
		        	type: Object,
					readOnly: true,
					value() {
		        		// This can be removed once https://github.com/firebase/polymerfire/issues/221 is closed.
						switch (location.hostname) {
							case 'lightning-round.firebaseapp.com': firebase.initializeApp(PROD_CONFIG); break;
							default: firebase.initializeApp(DEV_CONFIG); break;
						}
					}
				}
			},

			userIsLoggedInAndNotAdmin(user, adminData) {
				return user && (!adminData || Object.keys(adminData).length === 0);
			},

			userIsAdmin(user, adminData) {
		       return user && adminData && typeof adminData === 'string';
			},

			login() {
				return this.$.auth.signInWithPopup();
			},

			logout() {
				return this.$.auth.signOut();
			}
		});
	</script>
</dom-module>
